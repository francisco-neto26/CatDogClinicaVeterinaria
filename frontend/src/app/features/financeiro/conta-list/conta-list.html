<div class="surface-ground px-4 py-5 min-h-screen">
    
    <div class="surface-card p-4 shadow-2 border-round mb-4 flex justify-content-between align-items-center">
        <div class="flex align-items-center gap-3">
            <span class="p-float-label">
                <p-inputnumber [(ngModel)]="agendamentoIdSearch" inputId="agendamentoId" [useGrouping]="false" />
                <label for="agendamentoId">ID Agendamento</label>
            </span>
            <p-button label="Abrir Conta" icon="pi pi-folder-open" (onClick)="buscarContaPorAgendamento()" />
        </div>
        <p-button label="Nova Conta (Manual)" icon="pi pi-plus" severity="success" (onClick)="buscarContaPorAgendamento()" 
                  pTooltip="Digite o ID do agendamento ao lado e clique aqui" />
    </div>

    @if (!contaAtual() && listaContas().length > 0) {
        <div class="surface-card p-4 shadow-2 border-round mb-4">
            <div class="mb-3 text-xl font-bold text-900">Contas de {{ preSelectedClientName }}</div>
            <p-table [value]="listaContas()" styleClass="p-datatable-striped">
                <ng-template #header>
                    <tr>
                        <th>Conta ID</th>
                        <th>Agendamento</th>
                        <th>Emissão</th>
                        <th>Status</th>
                        <th>Valor Total</th>
                        <th>Ação</th>
                    </tr>
                </ng-template>
                <ng-template #body let-c>
                    <tr>
                        <td>{{ c.id }}</td>
                        <td>#{{ c.agendamentoId }}</td>
                        <td>{{ c.dataEmissao | date:'dd/MM/yyyy HH:mm' }}</td>
                        <td>
                            <p-tag [value]="c.status" [severity]="c.status === 'ABERTA' ? 'success' : 'secondary'" />
                        </td>
                        <td class="font-bold">{{ c.valorTotal | currency:'BRL' }}</td>
                        <td>
                            <p-button icon="pi pi-eye" [text]="true" (onClick)="selecionarConta(c)" pTooltip="Ver Detalhes" />
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    }

    @if (contaAtual()) {
        <div class="surface-card p-4 shadow-2 border-round">
            <div class="flex justify-content-between align-items-center mb-4">
                <div>
                    <div class="flex align-items-center gap-2">
                         @if (listaContas().length > 0) {
                            <p-button icon="pi pi-arrow-left" [text]="true" (onClick)="voltarParaLista()" pTooltip="Voltar" />
                         }
                         <h2 class="m-0">Conta #{{ contaAtual().id }}</h2>
                    </div>
                    <div class="mt-2 ml-2">
                        <p-tag [value]="contaAtual().status" [severity]="contaAtual().status === 'ABERTA' ? 'success' : 'secondary'" />
                        <span class="ml-3 text-500">Agendamento #{{ contaAtual().agendamentoId }}</span>
                    </div>
                </div>
                
                @if (contaAtual().status === 'ABERTA') {
                    <div class="flex gap-2">
                        <p-button label="Adicionar Item" icon="pi pi-plus" severity="info" (onClick)="dialogItemVisible.set(true)" />
                        <p-button label="Fechar Conta" icon="pi pi-check-square" severity="warn" (onClick)="fecharConta()" />
                    </div>
                }
            </div>

            <p-table [value]="contaAtual().itens" styleClass="p-datatable-sm">
                <ng-template #header>
                    <tr>
                        <th>Item</th>
                        <th>Qtd</th>
                        <th>Preço Unit.</th>
                        <th>Subtotal</th>
                        <th></th>
                    </tr>
                </ng-template>
                <ng-template #body let-item>
                    <tr>
                        <td>{{ item.itemServicoDescricao }}</td>
                        <td>{{ item.quantidade }}</td>
                        <td>{{ item.precoUnitarioMomento | currency:'BRL' }}</td>
                        <td class="font-bold">{{ item.subtotal | currency:'BRL' }}</td>
                        <td>
                             @if (contaAtual().status === 'ABERTA') {
                                <p-button icon="pi pi-trash" [text]="true" severity="danger" (onClick)="removerItem(item.id)" />
                             }
                        </td>
                    </tr>
                </ng-template>
                <ng-template #footer>
                    <tr>
                        <td colspan="3" class="text-right font-bold text-xl">Total:</td>
                        <td class="font-bold text-xl text-green-600">{{ contaAtual().valorTotal | currency:'BRL' }}</td>
                        <td></td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    }
</div>

<p-dialog [(visible)]="dialogItemVisible" header="Adicionar Serviço/Produto" [modal]="true" [style]="{width: '400px'}">
    <div class="flex flex-column gap-3 pt-2">
        <label class="font-bold">Item do Catálogo</label>
        <p-select 
            [options]="itensCatalogo()" 
            [(ngModel)]="selectedItemId" 
            optionLabel="descricao" 
            optionValue="id" 
            placeholder="Selecione..." 
            class="w-full"
            appendTo="body"
            [filter]="true" 
            filterBy="descricao" />

        <label class="font-bold">Quantidade</label>
        <p-inputnumber [(ngModel)]="quantidadeItem" [min]="1" [showButtons]="true" buttonLayout="horizontal" class="w-full" />
    </div>
    <ng-template #footer>
        <p-button label="Adicionar" icon="pi pi-plus" (onClick)="adicionarItem()" />
    </ng-template>
</p-dialog>