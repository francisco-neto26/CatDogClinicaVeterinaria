<div class="surface-ground px-4 py-5 min-h-screen">
    <div class="surface-card p-4 shadow-2 border-round mb-4">
        <div class="flex align-items-center gap-3">
            <span class="p-float-label">
                <p-inputnumber [(ngModel)]="agendamentoIdSearch" inputId="agendamentoId" [useGrouping]="false" />
                <label for="agendamentoId">ID do Agendamento</label>
            </span>
            <p-button label="Buscar / Abrir Conta" icon="pi pi-search" (onClick)="buscarConta()" />
        </div>
    </div>

    @if (contaAtual()) {
        <div class="surface-card p-4 shadow-2 border-round">
            <div class="flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="m-0">Conta #{{ contaAtual().id }}</h2>
                    <div class="mt-2">
                        <p-tag [value]="contaAtual().status" [severity]="contaAtual().status === 'ABERTA' ? 'success' : 'secondary'" />
                        <span class="ml-3 text-500">Cliente ID: {{ contaAtual().clienteId }}</span>
                    </div>
                </div>
                
                @if (contaAtual().status === 'ABERTA') {
                    <div class="flex gap-2">
                        <p-button label="Adicionar Item" icon="pi pi-plus" severity="info" (onClick)="dialogItemVisible.set(true)" />
                        <p-button label="Fechar Conta" icon="pi pi-check-square" severity="warn" (onClick)="fecharConta()" />
                    </div>
                }
            </div>

            <p-table [value]="contaAtual().itens" styleClass="p-datatable-sm">
                <ng-template #header>
                    <tr>
                        <th>Item</th>
                        <th>Qtd</th>
                        <th>Preço Unit.</th>
                        <th>Subtotal</th>
                        <th></th>
                    </tr>
                </ng-template>
                <ng-template #body let-item>
                    <tr>
                        <td>{{ item.itemServicoDescricao }}</td>
                        <td>{{ item.quantidade }}</td>
                        <td>{{ item.precoUnitarioMomento | currency:'BRL' }}</td>
                        <td class="font-bold">{{ item.subtotal | currency:'BRL' }}</td>
                        <td>
                             @if (contaAtual().status === 'ABERTA') {
                                <p-button icon="pi pi-trash" [text]="true" severity="danger" (onClick)="removerItem(item.id)" />
                             }
                        </td>
                    </tr>
                </ng-template>
                <ng-template #footer>
                    <tr>
                        <td colspan="3" class="text-right font-bold text-xl">Total:</td>
                        <td class="font-bold text-xl text-green-600">{{ contaAtual().valorTotal | currency:'BRL' }}</td>
                        <td></td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    }
</div>

<p-dialog [(visible)]="dialogItemVisible" header="Adicionar Serviço/Produto" [modal]="true" [style]="{width: '400px'}">
    <div class="flex flex-column gap-3 pt-2">
        <label class="font-bold">Item do Catálogo</label>
        <p-select 
            [options]="itensCatalogo()" 
            [(ngModel)]="selectedItemId" 
            optionLabel="descricao" 
            optionValue="id" 
            placeholder="Selecione..." 
            class="w-full"
            appendTo="body"
            [filter]="true" 
            filterBy="descricao" />

        <label class="font-bold">Quantidade</label>
        <p-inputnumber [(ngModel)]="quantidadeItem" [min]="1" [showButtons]="true" buttonLayout="horizontal" class="w-full" />
    </div>
    <ng-template #footer>
        <p-button label="Adicionar" icon="pi pi-plus" (onClick)="adicionarItem()" />
    </ng-template>
</p-dialog>